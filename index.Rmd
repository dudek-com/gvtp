---
title: "GVTP"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    lib_dir: index_libs
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

## Skim

```{r}
# load libraries ----
if (!require(librarian)){
  install.packages(librarian)
  library(librarian)
}
# load libraries, install if missing
shelf(
  # tables
  DT,
  # plots
  kassambara/easyGgplot2, ggplot2, trelliscopejs, gapminder,
  # sdm
  corrplot, dismo, mgcv, randomForest, sdm,
  # data wrangling
  dplyr, purrr, readr, readxl, tidyr,
  # utilities
  fs, glue, here, htmltools, skimr)
# sdm::installAll() # run once
select = dplyr::select

# paths & variables ----
dir_gdrive <- case_when(
  Sys.info()[['user']] == "bbest" ~ "/Volumes/GoogleDrive/My Drive/projects/dudek")
d_xls    <- path(dir_gdrive, "data/gvtp_hab_char_data_compiled_Final.xls")
cols_xls <- path(dir_gdrive, "data/gvtp_hab_char_columns.xlsx")
# excel_sheets(d_xls)

# read sheets of data
plot   <- read_excel(d_xls, "Plot")
spp    <- read_excel(d_xls, "Species")
soil   <- read_excel(d_xls, "Soil Layers")
veg    <- read_excel(d_xls, "Veg")
herbht <- read_excel(d_xls, "Herb Height")
gvtpht <- read_excel(d_xls, "GVTP Height Heads")
rdm    <- read_excel(d_xls, "RDM")
```

```{r, eval = F}
# skim sheets
h3("plot")
skim(plot)
h3("spp")
skim(spp)
h3("soil")
skim(soil)
h3("veg")
skim(veg)
h3("herbht")
skim(herbht)
h3("gvtpht")
skim(gvtpht)
h3("rdm")
skim(rdm)
```

## Predictors prep

### Plot

```{r}
d <- plot %>% 
  filter(!is.na(gvtp_count)) %>% 
  mutate(
    gvtp = as.integer(!gvtp_count == "0")) %>% 
  select_if(is.numeric)

predictors <- setdiff(names(d), c("plot", "gvtp")) %>% sort()

d <- d %>% 
  select(gvtp, all_of(predictors))

# abbreviate names
d_cols_abbr <- abbreviate(names(d), minlength=4)
names(d) <- d_cols_abbr
d_cols <- tibble(
  column_original = names(d_cols_abbr),
  column_abbreviated = d_cols_abbr)
write_csv(d_cols, cols_xls)
datatable(d_cols)

datatable(d)

d_long <- d %>% 
  pivot_longer(-gvtp, "variable") %>%
  #filter(variable %in% (unique(.$variable) %>% head(5))) %>% 
  mutate(
    gvtp = as.factor(gvtp)) %>% 
  arrange(variable, gvtp, value)
  
d_gvtp_avg <- d_long %>% 
  group_by(variable, gvtp) %>% 
  summarize(
    avg     = mean(value, na.rm=T), 
    sd      = sd(value, na.rm=T),
    .groups="drop")

d_gvtp_ttest <- d_long %>% 
  #filter(variable %in% (unique(.$variable) %>% head(5))) %>% 
  group_by(variable) %>% 
  summarize(
    t_test = oneway.test(value ~ gvtp, var.equal = T)$p.value) %>% 
  arrange(t_test) #  View(d_gvtp_ttest)
datatable(d_gvtp_ttest)

ggplot(d_long, aes(x=value, fill=gvtp, color=gvtp)) +
  #facet_wrap(facets = vars(variable)) +
  geom_density(alpha=0.2) +
  geom_histogram(
    aes(y=..density..), position="identity", alpha=0.5) +
  # facet_trelliscope() not working w/ other data, eg geom_vline(avg)
  #   https://github.com/hafen/trelliscopejs/issues/74
  # geom_vline(
  #   data = d_avg,
  #   aes(xintercept=avg, color=gvtp),
  #   linetype="dashed") +
  facet_trelliscope(
    ~variable, scales = "free",
    path = "index_libs/trelli_predictors")
```

### Correlation among predictors

* [Introduction to SDMs: data preparation and simple model fitting](https://damariszurell.github.io/HU-GCIB/3_SDM_intro.html)

```{r}
# We first estimate a correlation matrix from the predictors. We use Spearman rank correlation coefficient, as we do not know whether all variables are normally distributed.
cor_mat <- cor(d[,-1], method='spearman')

# We can visualise this correlation matrix. For better visibility, we plot the correlation coefficients as percentages.
corrplot.mixed(cor_mat, tl.pos='lt', tl.cex=0.5, number.cex=0.4, addCoefasPercent=T)
```

## SDM

Species distribution modeling...

### Maxent

* [Maxent -- Modeling methods | R Spatial](https://rspatial.org/raster/sdm/6_sdm_methods.html#maxent)

```{r}
# downloaded http://www.cs.princeton.edu/~schapire/maxent
#   and placed into system.file("java", package="dismo")
# maxent() # MaxEnt version 3.4.3 

predictors_ttest <- d_gvtp_ttest %>% 
  filter(t_test < 0.05) %>% 
  pull(variable)

d_a <- d %>% 
  select(gvtp, all_of(predictors_ttest))

set.seed(0)
i_k        <- kfold(d_a, 5)
d_a_train <- d_a[i_k != 1, ]
d_a_test  <- d_a[i_k == 1, ]

table(d_a_train$gvtp)
table(d_a_test$gvtp)

mx_a <- maxent(
  x = d_a_train %>% select(-gvtp), 
  p = d_a_train %>% select(gvtp))
plot(mx_a)

response(mx_a, var = c("cppr", "hr__", "zinc", "mcos"))

e <- evaluate(
  p = d_a_test %>% filter(gvtp == 1), 
  a = d_a_test %>% filter(gvtp == 0), 
  mx_a)
e
```

### Random Forest

```{r}
rf_a <- randomForest(gvtp ~ ., d_a_train)

e <- evaluate(
  p = d_a_test %>% filter(gvtp == 1), 
  a = d_a_test %>% filter(gvtp == 0), 
  rf_a)
e
```

### GAM

```{r}
gam_a <- gam(
  gvtp ~ s(cppr, k=5) + s(hr__, k=5) + s(zinc, k=5), 
  data = d_a_train, 
  family = binomial(link = "logit"))
summary(gam_a)

plot(gam_a, select=1)
plot(gam_a, select=2)
plot(gam_a, select=3)

vis.gam(gam_a,ticktype="detailed",color="heat",theta=-35)  
vis.gam(gam_a,se=2,theta=-35)

e <- evaluate(
  p = d_a_test %>% filter(gvtp == 1), 
  a = d_a_test %>% filter(gvtp == 0), 
  gam_a)
e
```

```{r, eval=F}
knitr::opts_chunk$set(eval = T)
```

### Fit models

* [sdm](http://www.biogeoinformatics.org/)

```{r}
d_sdm <- sdmData(gvtp ~ ., train = as.data.frame(d))
d_sdm

m1 <- sdm(
  gvtp ~ ., data = d_sdm, 
  methods = c("glm", "gam", "brt"))
m1

m2 <- sdm(
  gvtp ~ .,data = d_sdm,
  methods = c("rf", "tree", "fda", "mars", "svm"),
  replication = "sub", test.percent = 30, n = 2)

m2
getModelInfo(m2)

roc(m2)

roc(m2,smooth=T)
```

### Importance of predictors

```{r}
# gui(m2)

vi <- getVarImp(m2, id = 1, wtest = "training")

plot(vi,'cor')

vi@varImportance %>% 
  arrange(desc(corTest)) %>% 
  datatable()
```


## Next Steps

- subset of variables based on 1 per group in [gvtp_hab_char_columns.xlsx - Google Sheets](https://docs.google.com/spreadsheets/d/1LUjoRMollGuouUyfQeoAPbYC6Hl6i7kT/edit#gid=1414489956)
- want term plots:
  - gam
  - [R: Maxent](http://finzi.psych.upenn.edu/R/library/dismo/html/maxent.html)
- [Species distribution modeling â€” R Spatial](https://rspatial.org/raster/sdm/index.html)
- [6 Available Models | The caret Package](http://topepo.github.io/caret/available-models.html)
- [Lab 6. Species](http://benbestphd.com/landscape-ecology-labs/lab6.html)

## References

[Zotero group: dudek-gvtp](https://www.zotero.org/groups/2587262/dudek-gvtp/library)

