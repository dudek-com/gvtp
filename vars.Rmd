---
title: ""
output:
  officedown::rdocx_document: default
  word_document: default
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, echo = F, message = F)
```

```{r}
source("setup.R")
```


# Table of predictors

So far just for numeric predictors in the Plots worksheet.

```{r, eval = T}
d <- plot %>% 
  filter(!is.na(gvtp_count)) %>% 
  mutate(
    gvtp = as.integer(!gvtp_count == "0")) %>% 
  # TODO: handle non-numeric
  select_if(is.numeric) %>% 
  mutate(
    gvtp = gvtp == 1)
#table(d$gvtp)

#predictors <- setdiff(names(d), c("plot", "gvtp")) # %>% sort()

d_long <- d %>% 
  pivot_longer(-gvtp, "variable") # %>%
  # filter(variable %in% (unique(.$variable) %>% head(5))) # %>% 
  # mutate(
  #   gvtp = as.factor(gvtp)) %>% 
  #arrange(variable, gvtp, value)

d_long$var <- abbreviate(d_long$variable, minlength=4)

d_avg <- d_long %>% 
  select(-variable) %>% 
  group_by(var, gvtp) %>% 
  summarize(
    min     = min(value, na.rm=T), 
    avg     = mean(value, na.rm=T), 
    max     = max(value, na.rm=T),
    sd      = sd(value, na.rm=T),
    .groups="drop")

d_smry <- d_avg %>% 
  pivot_wider(
    -sd, 
    names_from = gvtp, 
    names_glue = "{ifelse(gvtp, 'p', 'a')}_{.value}",
    values_from = c(min, avg, max))

d_smry <- d_smry %>% 
  left_join(
    d_long %>% 
      group_by(var, variable) %>% 
      summarize(),
    by = "var")

plot_var <- function(var, redo = F){
  # var = "anns"
  var <- d_smry %>% 
    filter(var == !!var) %>% 
    pull(var)
  
  img <- here(glue("vars_imgs/{var}.png"))
  
  if (file.exists(img) & !redo)
    return(img)
  
  png(img, width = 4.8, height = 1.2, units="in", res=72)
  p <- d_long %>% 
    filter(var == !!var) %>% 
    ggplot(aes(x=value, fill=gvtp, color=gvtp)) +
    geom_density(alpha=0.2) +
    # geom_histogram(
    #   aes(y=..density..), position="identity", alpha=0.5) +
    geom_vline(
      data = d_avg %>% 
        filter(var == !!var),
      aes(xintercept=avg, color=gvtp),
      linetype="solid", lwd=2) +
    theme_nothing() + 
    scale_x_continuous(expand=c(0,0)) +
    scale_y_continuous(expand=c(0,0)) +
    labs(x = NULL, y = NULL)
  print(p)
  #ggsave(png, width=2, height=1, units="in", dpi=72)
  dev.off()
  
  img
}
```


```{r}
librarian::shelf(flextable, cowplot, officedown, officer)

d_smry <- d_smry %>% 
  mutate(
    nchar   = nchar(variable),
    Variable = strtrim(variable, 26),
    Absence  = glue("{signif(a_avg, 3)} ({signif(a_min, 3)} - {signif(a_max, 3)})"),
    Presence = glue("{signif(p_avg, 3)} ({signif(p_min, 3)} - {signif(p_max, 3)})"),
    Histogram = "",
    png = map_chr(var, plot_var, redo = F))

ft <- flextable(
  d_smry, 
  col_keys = c("Variable", "Absence", "Presence", "Histogram"))
ft <- compose(
  ft, i = 1:nrow(d_smry), j = "Histogram", 
  value = as_paragraph(as_image(src = png, width = 1.2, height = 0.3)))
ft <- autofit(ft)
ft
```


